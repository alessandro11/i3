#!/usr/bin/env bash

# BUG: THRE IS NO WAY TO SOURCE A FILE.
#      i3blocks does not even respect which environment
# that is running the script, always run with user default
# shell script.
# ANY VARS DECLARED IN ANOTHER SOURCE FILE WON'T WORK.
# . sys.conf

IFACE="br0"

fa_sitemap='\U000f0e8'
fa_arrow_circle_o_down='\U000f01a'
fa_caret_down='\U000f0d7'
fa_caret_up='\U000f0d8'
fa_arrow_circle_o_up='\U000f01b'

GetHummanReadble() {
	local val=$1
	local ret=""

	if [ $val -lt 1024 ]; then # less than KB
		ret="${val}B/s"
	elif [ $val -lt 1048576 ]; then  # less than MB
		ret="$(($val / 1024))KB/s"
	elif [ $val -lt 1073741824 ]; then # less than GB
		ret="$(($val / 1048576))MB/s"
	else
		ret="$(($val / 1073741824))GB/s"
	fi

	echo "$ret"
}

[ ! -f "/tmp/rx_tx_bytes" ] && echo 0 > "/tmp/rx_tx_bytes"

rx_tx_old=(`cat /tmp/rx_tx_bytes`)
bw=(`awk '/'"$IFACE"'/ {print $2, $10}' /proc/net/dev`)

rx_rate=$((${bw[0]} - ${rx_tx_old[0]}))
tx_rate=$((${bw[1]} - ${rx_tx_old[1]}))
echo ${bw[@]} > "/tmp/rx_tx_bytes"

color_up='#4dff4d'
color_down='#ff0000'
[ $rx_rate -eq 0 ] && color_down='#800000'
[ $tx_rate -eq 0 ] && color_up='#004d00'

rx_rate=$(GetHummanReadble $rx_rate)
tx_rate=$(GetHummanReadble $tx_rate)

echo -e "<span foreground='#53ff1a'>$fa_sitemap</span>"\
	 "<span foreground='#53ff1a' size='small'>$rx_rate</span>"\
	 "<span foreground='$color_down'>$fa_caret_down</span>"\
	 "<span foreground='#53ff1a' size='small'>$tx_rate</span>"\
	 "<span foreground='$color_up'>$fa_caret_up</span>"

exit 0
