#!/usr/bin/env sh

# BUG: THRE IS NO WAY TO SOURCE A FILE.
#      i3blocks does not even respect which environment
# that is running the script, always run with user default
# shell script.
# ANY VARS DECLARED IN ANOTHER SOURCE FILE WON'T WORK.
# . sys.conf

fa_thermometer_0='\U000f2cb'
fa_thermometer_quarter='\U000f2ca'
fa_thermometer_3='\U000f2c8'
fa_thermometer_half='\U000f2c9'
fa_thermometer_full='\U000f2c7'

fa_modx='\U000f285'

fa_microship='\U000f2db'

fa_gears='\U000f085'

CHIP="coretemp-isa-0000"

DEFAULT_COLOR="#53ff1a"
DEF_ICON_COLOR="#0066ff"

# Get average user usage of cpu
cpu() {
	echo "$(awk '/^cpu MHz/ {sum+=$4; count++} END{OFMT="%.2f"; print (sum/count)/1000}' /proc/cpuinfo)GHz"
}

cpu_fan() {
	local rpm=0

	rpm=`sensors -u dell_smm-virtual-0 | awk '/fan1_input:/ {print $2}'`
	echo ${rpm%%\.[0-9]*}
}

# Get the average temperature of all cpus.
temperature() {
	local mean_t=0

	mean_t=`sensors -u $CHIP |\
	awk '
		BEGIN {
			count=0
		}

		/temp[0-9]+_input:/ {
			temps+=$2
			count++
		}

		END {
			printf("%.2f\n", temps/count)
	   }
'`
	echo $mean_t
}


mean_t=$(temperature)
if [[ $mean_t < 50.00 ]]; then
	color="$DEF_ICON_COLOR"
	cpu_usage_color='#53ff1a'
	icon="$fa_thermometer_0"
elif [[ $mean_t < 60.00 ]]; then
	color="yellow"
	cpu_usage_color="yellow"
	icon="$fa_thermometer_half"
else
	color="red"
	cpu_usage_color="red"
	icon="$fa_thermometer_full"
fi

echo -e "<span foreground='$DEF_ICON_COLOR' size='small'>$fa_gears</span>"\
	 "<span foreground='$cpu_usage_color' size='small'>$(cpu)</span>"\
	 "<span foreground='$color' size='small'>$icon</span>"\
	 "<span foreground='$DEFAULT_COLOR' size='small'>$mean_tÂ°C</span>"
#	 "<span foreground='#53ff1a' size='x-small' font_desc='fontawesome-regular'>$fa_modx</span>"
#	 "<span foreground='#53ff1a' size='x-small'>$(cpu_fan) RPM</span>"

exit 0
